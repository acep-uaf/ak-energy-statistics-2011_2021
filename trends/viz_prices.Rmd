---
title: "revenue"
output: html_document
date: "2024-01-29"
editor_options: 
  chunk_output_type: console
---

### Build a library
```{R}
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)

library(readxl)
library(readr)

library(see)  # slices violin plots in half
library(ggridges) # mountains beyond mountains
library(ggrepel) # labels on ends of lines
library(ggdist) # raincloud plots
library(ggrain) # other raincloud package

```

### Set working directory
```{R}
repo <- "~/repos/ak-energy-statistics-2011_2021/"
setwd(repo)

```

### Load data
```{R}

price <- read_csv("./trends/raw/prices_pce_inflation_population.csv")

```


## subset of Residential Revenue all Regions, 2021
```{R}
# want statewide box too, so duplicate res_rev21, set ACEP energy region = "State", rbind back in.
tmp_state <- price %>% 
  mutate("ACEP Energy Region" = "State")


# subset residential 2021 data, drop rows with NAs
state <- rbind(price, tmp_state) %>%
  select(c("Year", 
           "Reporting Name", 
           "ACEP Energy Region", 
           residential_weighted_price,
           commercial_weighted_price,
           industrial_weighted
           ))

rm(tmp_state)


```




## pivot longer to get Residential, Commercial, Industrial
```{R}
p_price <- price %>%
             rename(c("Residential" = "Residential Price kWh (2021 dollars)",
                      "Commercial" = "Commercial Price kWh (2021 dollars)",
                      "Industrial" = "Industrial Price kWh (2021 dollars)")) %>%
             pivot_longer( 
             cols = c("Residential",
                      "Commercial",
                      "Industrial"), 
             names_to ="Type", 
             values_to = "Price")




```


## half violin of yearly data, grouped by region
```{R}


# plot
price %>%
  filter(Year == 2011) %>%
  ggplot( aes(x=`ACEP Energy Region`, y=`Residential Price kWh (2021 dollars)`, fill=`ACEP Energy Region`)) +
    # geom_boxplot(outlier.alpha = 0) +
    geom_violinhalf() +
    scale_fill_manual(values = c("#98BAD6", "#A4CD9A", "#E3918F")) +
    geom_jitter(color="black", size=0.4, alpha=0.8, width = 0.1, height = 0) +
    theme_classic() +
    theme(legend.position = "none",
          plot.title = element_text(size=20, hjust = 0.5),
          plot.subtitle = element_text(size=14, hjust = 0.5),
          plot.caption = element_text(size = 8)) +
  
    labs(title = "Price of Electricity, Residential, 2011",
         subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
         caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
         x = "Region",
         y = "Cents/kWh") +
  
    coord_flip() +
    
    ylim(c(0,50)) 
    

    #E3918F Rural Remote
    #98BAD6 Coastal
    #A4CD9A Railbelt
    #F1BF42 State

```


## raincloud plot of 2021 data, grouped by region
```{R}

plot_year <- 2017

# plot
price %>%
  filter(Year == plot_year) %>%
  ggplot( aes(x=`ACEP Energy Region`, y=`Residential Price kWh (2021 dollars)`, fill=`ACEP Energy Region`)) +

  
  geom_rain(alpha = 0.5, rain.side = 'r',
            violin.args = list(color = NA, alpha = 1),
            boxplot.args = list(alpha = 1, color = "black", outlier.shape = NA),
            boxplot.args.pos = list(
              position = ggpp::position_dodgenudge(x = .1, width = 0.1), width = 0.1
            )) +
  
  
    scale_fill_manual(values = c("#98BAD6", "#A4CD9A", "#E3918F")) +
    # geom_jitter(color="black", size=0.4, alpha=0.8, width = 0.1, height = 0) +
    theme_classic() +
    theme(legend.position = "none",
          plot.title = element_text(size=20, hjust = 0.5),
          plot.subtitle = element_text(size=14, hjust = 0.5),
          plot.caption = element_text(size = 8)) +
  
    labs(title = paste("Price of Electricity, Residential, ", plot_year, sep = ""),
         subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
         caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
         x = "Region",
         y = "Cents/kWh") +
  
    coord_flip() +
    
    ylim(c(0,75))
    

    #E3918F Rural Remote
    #98BAD6 Coastal
    #A4CD9A Railbelt
    #F1BF42 State

```



# region by residential/commercial/industrial
```{R}
plot_region <- "Railbelt"

viz <- price %>%
  filter(`ACEP Energy Region` == paste(plot_region)) %>%
  # drop_na(`Residential Price kWh (2021 dollars)`,
  #         `Commercial Price kWh (2021 dollars)`,
  #         `Industrial Price kWh (2021 dollars)`) %>%
  group_by(`ACEP Energy Region`, Year) %>%
  summarize(Residential = mean(`Residential Price kWh (2021 dollars)`, na.rm = TRUE),
            Commercial = mean(`Commercial Price kWh (2021 dollars)`, na.rm = TRUE),
            Industrial = mean(`Industrial Price kWh (2021 dollars)`, na.rm = TRUE)) %>%
   pivot_longer( 
     cols = c(Residential,
              Commercial,
              Industrial), 
     names_to = "Type", 
     values_to = "Price")

viz %>%  
  mutate(label = if_else(Year == max(Year), as.character(Type), NA_character_)) %>%
  ggplot( aes(y=Price, x=Year, color = Type)) +
  geom_line(linewidth=1.5) +
  geom_label_repel(aes(label = label,),
                  nudge_x = 1,
                  nudge_y = 1,
                  na.rm = TRUE) +
  theme_classic() +
  
  scale_color_manual(values = c("#848BA7", "#645345", "#8F6A9D")) + #Commercial, Industrial, Residential
  theme(legend.position = "none",
        plot.title = element_text(size=20, hjust = 0.5),
        plot.subtitle = element_text(size=14, hjust = 0.5),
        plot.caption = element_text(size = 8)) +
  
  labs(title = paste("Price of Electricity, ", plot_region, ", 2011-2021",sep = ""),
       subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
       caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
       x = "Year",
       y = "Cents per kWh") +

   ylim(c(0,30)) +
   scale_x_continuous(breaks=seq(2011,2021,2))



```




  summarize(Residential = mean(`Residential Price kWh (2021 dollars)`, na.rm = TRUE),
            Commercial = mean(`Commercial Price kWh (2021 dollars)`, na.rm = TRUE),
            Industrial = mean(`Industrial Price kWh (2021 dollars)`, na.rm = TRUE)) %>%

# regional averages
```{R}

viz <- state %>%
  group_by(`ACEP Energy Region`, Year) %>%
   pivot_longer( 
     cols = c(`Residential Price kWh (2021 dollars)`,
              `Commercial Price kWh (2021 dollars)`,
              `Industrial Price kWh (2021 dollars)`), 
     names_to = "Type", 
     values_to = "Price") %>%
  summarize(Price = mean(Price, na.rm = TRUE))

viz %>%  
  mutate(label = if_else(Year == max(Year), as.character(`ACEP Energy Region`), NA_character_)) %>%
  ggplot( aes(y=Price, x=Year, color = `ACEP Energy Region`)) +
  geom_line(linewidth=1.5) +
  geom_label_repel(aes(label = label,),
                  nudge_x = 1,
                  nudge_y = 1,
                  na.rm = TRUE) +
  theme_classic() +
  
  scale_color_manual(values = c("#98BAD6", "#A4CD9A", "#E3918F", "#F1BF42")) +
  theme(legend.position = "none",
        plot.title = element_text(size=20, hjust = 0.5),
        plot.subtitle = element_text(size=14, hjust = 0.5),
        plot.caption = element_text(size = 8)) +
  
  labs(title = "Average Price of Electricity, 2011-2021",
       subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
       caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
       x = "Year",
       y = "Cents per kWh") +

   scale_x_continuous(breaks=seq(2011,2021,2))





```


```{R}
# ridges over time
price %>%
  filter(`ACEP Energy Region` == "Coastal") %>%
  mutate(YearFct = fct_rev(as.factor(Year))) %>%
  ggplot( aes(x=`Residential Price kWh (2021 dollars)`, y=YearFct, fill = YearFct)) +
  geom_density_ridges() + 
  theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Price per kWh (2021 dollars), Coastal Residential")




# Boxplot of revenue
plot_region <- "Railbelt"
price %>%
  filter(`ACEP Energy Region` == paste(plot_region)) %>%
  mutate(YearFct = as.factor(Year)) %>% 
  
  ggplot( aes(y=`Residential Price kWh (2021 dollars)`, x=YearFct, fill = YearFct)) +
  # geom_violin() +
  geom_boxplot(outlier.alpha = 0) +
  theme_classic() +
  
  theme(legend.position = "none") +
  ggtitle(paste("Revenue per kWh, Residential, ", plot_region, sep = " ")) +
  ylab("Revenue per kWh, cents") +
  xlab("Year") +
  
  ylim(c(0,100)) 


```





# ridges over time
```{R}

# subset residential 2021 data, drop rows with NAs
# price <- rev11_21 %>% 
#   select(c("Year", "Reporting name", "ACEP energy region", "Residential revenue (1000$)", "Residential Sales (MWh)", "`Residential Revenue kWh`" )) %>%
#   drop_na(`Residential Revenue kWh`)
# 
# 
# 
# 
# price %>%
#   filter(`ACEP energy region` == "Coastal") %>%
#   mutate(YearFct = fct_rev(as.factor(Year))) %>%
#   ggplot( aes(x=`Residential Revenue kWh`, y=YearFct, fill = YearFct)) +
#   geom_density_ridges() + 
#   theme_classic() +
#   ggtitle("Revenue, Coastal")

```

















# Junkyard below

#NON WEIGHTED
## boxplot of 2021 data, grouped by region
```{R}


# plot
price %>%
  filter(Year == 2011) %>%
  ggplot( aes(x=`ACEP Energy Region`, y=`Residential Price kWh (2021 dollars)`, fill=`ACEP Energy Region`)) +
    # geom_boxplot(outlier.alpha = 0) +
    geom_violinhalf() +
    scale_fill_manual(values = c("#98BAD6", "#A4CD9A", "#E3918F")) +
    geom_jitter(color="black", size=0.4, alpha=0.8, width = 0.1, height = 0) +
    theme_classic() +
    theme(legend.position = "none",
          plot.title = element_text(size=20, hjust = 0.5),
          plot.subtitle = element_text(size=14, hjust = 0.5),
          plot.caption = element_text(size = 8)) +
  
    labs(title = "Price of Electricity, Residential, 2011",
         subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
         caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
         x = "Region",
         y = "Cents/kWh") +
  
    coord_flip() +
    
    ylim(c(0,50)) 
    

    #E3918F Rural Remote
    #98BAD6 Coastal
    #A4CD9A Railbelt
    #F1BF42 State

```




# DEPRECATED price over time
# boxplots over time by region, facet-wrapped
# too busy!
```{R}
# facet_grid by region by residential/commercial/industrial
p_price %>%
  filter(`ACEP Energy Region` == "Coastal") %>%
  mutate(YearFct = as.factor(Year)) %>%

  # boxplot code
  ggplot( aes(y=Price, x=YearFct, fill = YearFct)) +
  geom_boxplot(outlier.alpha = 0) +
  facet_grid(~Type) +
  theme_classic() +

  theme(legend.position = "none",
        plot.title = element_text(size=20, hjust = 0.5),
        plot.subtitle = element_text(size=14, hjust = 0.5),
        plot.caption = element_text(size = 8)) +
  
  labs(title = "Price of Electricity, Coastal, 2011-2021",
       subtitle = "Inflation-adjusted to 2021 dollars, post PCE Subsidy",
       caption = "Inflation-adjustment calculated using BLS Cost Price Index, AK Urban",
       x = "Year",
       y = "Cents per kWh") 

  ylim(c(0,100))
  

```


## dealing with outliers in rural remote
```{R}
data <- res_rev21
dim(data)
 
list_quantiles <- tapply(data$`Residential Revenue kWh`, data$`ACEP energy region`, quantile)
 
Q1s <- sapply(1:3, function(i) list_quantiles[[i]][2])
Q3s <- sapply(1:3, function(i) list_quantiles[[i]][4])
 
IQRs <- tapply(data$`Residential Revenue kWh`, data$`ACEP energy region`, IQR)
 
Lowers <- Q1s - 1.5*IQRs
Uppers <- Q3s + 1.5*IQRs
 
datas <- split(data, data$`ACEP energy region`)
 
data_no_outlier <- NULL
for (i in 1:3){
out <- subset(datas[[i]], datas[[i]]$`Residential Revenue kWh` > Lowers[i] & datas[[i]]$`Residential Revenue kWh` < Uppers[i])
data_no_outlier <- rbind(data_no_outlier, out)
}
 
dim(data_no_outlier)



```

## colnames comparison
probably not worth pursuing, just pull common columns and join
```{R}
cols <- data.frame   (col2021 = c(colnames(rev2021)), 
                      col2020 = c(colnames(rev2020)),
                      col2019 = c(colnames(rev2019)),
                      col2018 = c(colnames(rev2018)),
                      col2017 = c(colnames(rev2017)),
                      col2016 = c(colnames(rev2016))
                      )
```









